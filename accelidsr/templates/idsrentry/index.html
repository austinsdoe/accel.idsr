{% extends "base.html" %}

{% block title %}
IDSR Input Form
{% endblock %}

{% block head %}
    {{ super() }}
    <!-- JQuery and JQueryUI -->
    <script type="text/javascript" src="{{ url_for('static', filename='js/jquery-3.1.1.min.js') }} "></script>
    <script type="text/javascript" src="{{ url_for('static', filename='jqueryui/jquery-ui.min.js') }} "></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/jquery.validate.js') }}"></script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='jqueryui/jquery-ui.min.css') }}"/>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='jqueryui/jquery-ui.structure.min.css') }}"/>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/new.css') }}"/>
    <script type="text/javascript">
    (function ($) {
        $(document).ready(function () {
            $("input[input-type='date']").datepicker({ dateFormat: 'dd/mm/yy' });

            $('select').each(function(){
                var hidid = $(this).attr('id')+"_text";
                $(this).after('<input type="hidden" id="'+hidid+'" name="'+hidid+'"></input>');
            });
            $('select').change(function (e) {
                var hidid = $(this).attr('id')+"_text";
                $('#'+hidid).val($(this).find('option:selected').html());
            });

            // Updates the selection list of district in accordance with the
            // selected option from the reporting county selection list
            $('select[id="reporting_country"]').change(function (e) {
                var country = $(this).val();
                var hidid = $(this).attr('id')+"_text";
                $('#'+hidid).val($(this).find('option:selected').html());
                $.post( "/idsrentry/@@json/getDistrictChoices", { county: country, }, function(data) {
                    $('select[id="reporting_district"] option').remove();
                    $('input[id="reporting_district_dynamic"]').val('');
                    vals = []
                    $.each(data, function( i, val ) {
                        var option = '<option value='+val[0]+'>'+val[1]+'</option>';
                        $('select[id="reporting_district"]').append(option);
                        if (val[0] != '') {
                            vals.push(val[0]);
                        }
                    });
                    $('input[id="reporting_district_dynamic"]').val(vals.join('|'));
                }, "json");
            });

            // Updates the selection list of district in accordance with the
            // selected option from the reporting county selection list
            $('select[id="patient_county_of_residence"]').change(function (e) {
                var country = $(this).val();
                var hidid = $(this).attr('id')+"_text";
                $('#'+hidid).val($(this).find('option:selected').html());
                $.post( "/idsrentry/@@json/getDistrictChoices", { county: country, }, function(data) {
                    $('select[id="patient_district_of_residence"] option').remove();
                    $('input[id="patient_district_of_residence_dynamic"]').val('');
                    vals = []
                    $.each(data, function( i, val ) {
                        var option = '<option value='+val[0]+'>'+val[1]+'</option>';
                        $('select[id="patient_district_of_residence"]').append(option);
                        if (val[0] != '') {
                            vals.push(val[0]);
                        }
                    });
                    $('input[id="patient_district_of_residence_dynamic"]').val(vals.join('|'));
                }, "json");
            });

            // Updates the selection list of facilities in accordance with the
            // selected option from the reporting county and district selection
            // lists
            $('select[id="reporting_district"]').change(function (e) {
                var country = $('select[id="reporting_country"]').val();
                var district = $(this).val();
                var hidid = $(this).attr('id')+"_text";
                $('#'+hidid).val($(this).find('option:selected').html());
                $.post( "/idsrentry/@@json/getFacilityChoices", { county: country, district: district }, function(data) {
                    $('select[id="reporting_health_facility"] option').remove();
                    $('input[id="reporting_health_facility_dynamic"]').val('');
                    $.each(data, function( i, val ) {
                        var option = '<option value='+val[0]+'>'+val[1]+'</option>';
                        $('select[id="reporting_health_facility"]').append(option);
                        if (val[0] != '') {
                            vals.push(val[0]);
                        }
                    });
                    $('input[id="reporting_health_facility_dynamic"]').val(vals.join('|'));
                }, "json");
            });

            // Diagnosis "other... logic".
            if ($('input[type=radio][id^="diagnosis-"][value="_other"]').is(':checked')) {
                $('input[id=diagnosis_other]').addClass('required');
                $('input[id=diagnosis_other]').prop('required', true);
                $('input[id=diagnosis_other]').parent('div.formline').show();
                $('input[id=diagnosis_other]').parent('div.formline').addClass('required');
            } else {
                $('input[id=diagnosis_other]').parent('div.formline').hide();
                $('input[id=diagnosis_other]').val('');
            }
            $('input[type=radio][id^="diagnosis-"]').change(function(e) {
                if ($(this).val() == '_other' && $(this).is(':checked')) {
                    $('input[id=diagnosis_other]').addClass('required');
                    $('input[id=diagnosis_other]').prop('required', true);
                    $('input[id=diagnosis_other]').parent('div.formline').show();
                    $('input[id=diagnosis_other]').parent('div.formline').addClass('required');
                } else {
                    $('input[id=diagnosis_other]').val('');
                    $('input[id=diagnosis_other]').removeClass('required');
                    $('input[id=diagnosis_other]').removeAttr('required');
                    $('input[id=diagnosis_other]').parent('div.formline').hide();
                    $('input[id=diagnosis_other]').parent('div.formline').removeClass('required');
                }
            });

            // Browser navigator
            $('div.form-footer a.navlink').click(function(e) {
                e.preventDefault();
                var navstep = $(this).attr('href');
                $(navstep).show();
                $(this).closest('div.substep').hide();
            });
        })
    })(jQuery);
    </script>
{% endblock %}

{% block content %}
<h1>IDSR Form Submission</h1>
{% from "idsrentry/_formhelpers.html" import render_stepsnav %}
{% from "idsrentry/_formhelpers.html" import render_substepsnav %}
{% from "idsrentry/_formhelpers.html" import render_fields %}
{% from "idsrentry/_formhelpers.html" import render_formfooter %}
{{ render_stepsnav(form, steps) }}
{{ render_substepsnav(form)}}
<form action="" method="post" id="{{ form.step }}" name="{{ form.step }}">
    <div class='form'>
    {{ form.hidden_tag() }}
    {{ render_fields(form, steps) }}
    </div>
    <div class="form-footer">
    {{ render_formfooter(form) }}
    </div>
</form>
{% endblock %}
