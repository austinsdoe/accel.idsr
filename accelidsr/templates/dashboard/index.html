{% extends "base.html" %}

{% block title %}
IDSR Input Form
{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/new.css') }}"/>
    <script type='text/javascript'>
    (function ($) {
        $(document).ready(function () {
            $('#filter-all').click(function(e){
                e.preventDefault();
                $('.current').removeClass('current');
                $(this).addClass('current');
                filter();
            });
            $('[id^="filter-"]').click(function(e){
                e.preventDefault();
                var id = $(this).attr('id').split("-");
                if ( id.length < 3) {
                  return true;
                }
                var f_name=id[1];
                $('#filter-all').removeClass('current');
                if ($(this).hasClass('current')) {
                    $(this).removeClass('current');
                }else{
                  $('[id^="filter-'+f_name+'"]').removeClass('current');
                  $(this).addClass('current');
                }
                filter();
            });
            function hide_all_items(){
              $('div.items-table table tbody tr').show();
            };
            function filter(){
              hide_all_items();
              var cur_filters = $('.current');
              if (cur_filters.length == 0) {
                $('#filter-all').addClass('current');
                return true;
              }
              for (var i = 0; i < cur_filters.length; i++) {
                var id = cur_filters[i].id.split("-");
                if ( id.length < 3 || id[0] != "filter") {
                  continue;
                }
                var items = $('div.items-table table tbody tr');
                var f_name=id[1];
                var f_values= id[2].split(":");
                for (var k = 0; k < items.length; k++) {
                  var item = items[k];
                  var at_value = item.getAttribute('data-'+f_name);
                  if ( $.inArray(at_value, f_values) == -1){
                    item.style.display='none';
                  }
                }
              }
            };
        });
    })(jQuery);
    </script>
{% endblock %}

{% block content %}
<h1>Dashboard</h1>
<div class='buttons-bar'>
    <a href="/idsrentry/a">New IDSR Form</a>
</div>
<div class='filters'>
    <a id='filter-all' class='current' href="#">All IDSRs</a>
    <a id='filter-created-{{ current_user.get_username() }}' href="#">My IDSRs</a>
    <a id='filter-bikastatus-in_queue:pending:inserted' href="#">Active IDSRs</a>
    <a id='filter-bikastatus-cancelled' href="#">Cancelled IDSRs</a>
</div>
<div class='items-table'>
{% from "dashboard/macros.html" import render_idsr_table_header %}
{% from "dashboard/macros.html" import render_idsr_row %}
<form action="doaction" method="post">
<table>
    <thead>
        {{ render_idsr_table_header(items) }}
    </thead>
    <tbody>
        {% for idsrobj in items %}
        {% set idsrdict = idsrobj.getDict() %}
        {% set idobj = idsrobj.getId() %}
        {% set statuses = ['a', 'b', 'c', 'd'] %}
        {% set bikastatus = idsrdict.get('bika-status', 'pending') %}
        <tr class="{{ loop.cycle('odd', 'even') }}" data-created="{{ idsrdict.get('createdby', 'unk') }}" data-bikastatus="{{ idsrdict.get('bika-status', 'unk') }}">
            <td>
              <input type="checkbox" name="chk_idsr_ids" id="chk_idsr_ids_{{ idobj }}" value= "{{ idobj }}">
            </td>
            <td class='status'>
                {% for st in statuses %}
                    <a href="/idsrentry/{{ st }}?id={{ idobj }}" class="{{ idsrdict.get('idsr-status-'+st, 'empty') }}">{{ st }}</a>
                {% endfor %}
                <span class="bika-status bika-status-{{ bikastatus }}">{{ bikastatus|replace("_", " ") }}</span>
            </td>
            {% set repdate = idsrdict.get('reporting_date', '') %}
            {% set repdatf = repdate.strftime('%d/%m/%Y') if repdate else '' %}
            <td>{{ repdatf }}</td>
            <td>{{ idsrdict.get('case_id', '') }}</td>
            <td>{{ idsrdict.get('reporting_country_text', '') }}</td>
            <td>{{ idsrdict.get('reporting_district_text', '') }}</td>
            <td>{{ idsrdict.get('reporting_health_facility_text', '') }}</td>
            <td>{{ idsrdict.get('createdby', '')}}</td>
            <td>{{ idsrobj.created() }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<div class="items-buttons">
  <input type="submit" name="action" value="Cancel" class="cancel" />
</div>
</form>
</div>
{% endblock %}
